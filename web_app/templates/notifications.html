{% extends "base.html" %}

{% block title %}–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞{% endblock %}

{% block extra_css %}
<style>
.notification-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.notification-card.inactive {
    border-left-color: #6c757d;
    opacity: 0.7;
}

.notification-card.active {
    border-left-color: #28a745;
}

.notification-type-badge {
    font-size: 0.8em;
    padding: 0.25rem 0.5rem;
}

.form-section {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
}

.form-section h6 {
    color: #495057;
    margin-bottom: 1rem;
    font-weight: 600;
}

.frequency-option {
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.frequency-option:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.frequency-option.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.frequency-option input[type="radio"] {
    margin-right: 0.5rem;
}

.day-selector {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    background-color: #fff;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
}

.day-button {
    width: 45px;
    height: 45px;
    margin: 0.25rem;
    border: 2px solid #dee2e6;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.day-button:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.day-button.selected {
    border-color: #007bff;
    background-color: #007bff;
    color: white;
}

.weekday-button {
    width: 60px;
    height: 45px;
    margin: 0.25rem;
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.weekday-button:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.weekday-button.selected {
    border-color: #007bff;
    background-color: #007bff;
    color: white;
}

.time-input-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.preview-section {
    background-color: #e8f5e8;
    border: 1px solid #c3e6c3;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
}

.simple-form {
    max-width: 800px;
    margin: 0 auto;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {{ user.full_name }} ({{ user.telegram_id }})</h2>
            
            <!-- –ü—Ä–æ—Å—Ç–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-plus-circle"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h5>
                </div>
                <div class="card-body">
                    <div class="simple-form">
                        <form id="simpleNotificationForm">
                            <input type="hidden" id="userId" value="{{ user.telegram_id }}">
                            
                            <!-- –¢–µ–∫—Å—Ç —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è -->
                            <div class="form-section">
                                <h6><i class="fas fa-comment"></i> –©–æ –Ω–∞–ø–∏—Å–∞—Ç–∏ –≤ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—ñ?</h6>
                                <textarea class="form-control form-control-lg" id="notificationText" rows="3" 
                                          placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ß–∞—Å –¥–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è! üí™" required></textarea>
                            </div>
                            
                            <!-- –¢–∏–ø —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è -->
                            <div class="form-section">
                                <h6><i class="fas fa-bell"></i> –¢–∏–ø —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="frequency-option" onclick="selectNotificationType('daily_morning_notification')">
                                            <input type="radio" name="notificationType" value="daily_morning_notification" id="typeMorning">
                                            <label for="typeMorning">
                                                <strong>üåÖ –†–∞–Ω–∫–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</strong><br>
                                                <small class="text-muted">–©–æ–¥–µ–Ω–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –¥–ª—è –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="frequency-option" onclick="selectNotificationType('after_training_notification')">
                                            <input type="radio" name="notificationType" value="after_training_notification" id="typeTraining">
                                            <label for="typeTraining">
                                                <strong>üèãÔ∏è –ü—ñ—Å–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</strong><br>
                                                <small class="text-muted">–û–ø–∏—Ç—É–≤–∞–Ω–Ω—è –ø—ñ—Å–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="frequency-option" onclick="selectNotificationType('custom_notification')">
                                            <input type="radio" name="notificationType" value="custom_notification" id="typeCustom">
                                            <label for="typeCustom">
                                                <strong>‚öôÔ∏è –í–ª–∞—Å–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</strong><br>
                                                <small class="text-muted">–ù–∞–ª–∞—à—Ç–æ–≤—É–≤–∞–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –ß–∞—Å—Ç–æ—Ç–∞ –¥–ª—è –≤–ª–∞—Å–Ω–∏—Ö —Å–ø–æ–≤—ñ—â–µ–Ω—å -->
                            <div class="form-section" id="frequencySection" style="display: none;">
                                <h6><i class="fas fa-calendar"></i> –Ø–∫ —á–∞—Å—Ç–æ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏?</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="frequency-option" onclick="selectFrequency('daily')">
                                            <input type="radio" name="frequency" value="daily" id="freqDaily">
                                            <label for="freqDaily">
                                                <strong>üìÖ –©–æ–¥–Ω—è</strong><br>
                                                <small class="text-muted">–ö–æ–∂–Ω–æ–≥–æ –¥–Ω—è –≤ –∑–∞–∑–Ω–∞—á–µ–Ω–∏–π —á–∞—Å</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="frequency-option" onclick="selectFrequency('weekly')">
                                            <input type="radio" name="frequency" value="weekly" id="freqWeekly">
                                            <label for="freqWeekly">
                                                <strong>üìã –©–æ—Ç–∏–∂–Ω—è</strong><br>
                                                <small class="text-muted">–í –æ–±—Ä–∞–Ω—ñ –¥–Ω—ñ —Ç–∏–∂–Ω—è</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="frequency-option" onclick="selectFrequency('monthly')">
                                            <input type="radio" name="frequency" value="monthly" id="freqMonthly">
                                            <label for="freqMonthly">
                                                <strong>üìÜ –©–æ–º—ñ—Å—è—Ü—è</strong><br>
                                                <small class="text-muted">–í –æ–±—Ä–∞–Ω—ñ –¥–Ω—ñ –º—ñ—Å—è—Ü—è</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –í–∏–±—ñ—Ä –¥–Ω—ñ–≤ —Ç–∏–∂–Ω—è -->
                                <div class="day-selector" id="weekdaySelector">
                                    <h6>–û–±–µ—Ä—ñ—Ç—å –¥–Ω—ñ —Ç–∏–∂–Ω—è:</h6>
                                    <div class="d-flex flex-wrap justify-content-center">
                                        <button type="button" class="weekday-button" data-day="1" onclick="toggleWeekday(this)">–ü–Ω</button>
                                        <button type="button" class="weekday-button" data-day="2" onclick="toggleWeekday(this)">–í—Ç</button>
                                        <button type="button" class="weekday-button" data-day="3" onclick="toggleWeekday(this)">–°—Ä</button>
                                        <button type="button" class="weekday-button" data-day="4" onclick="toggleWeekday(this)">–ß—Ç</button>
                                        <button type="button" class="weekday-button" data-day="5" onclick="toggleWeekday(this)">–ü—Ç</button>
                                        <button type="button" class="weekday-button" data-day="6" onclick="toggleWeekday(this)">–°–±</button>
                                        <button type="button" class="weekday-button" data-day="0" onclick="toggleWeekday(this)">–ù–¥</button>
                                    </div>
                                </div>
                                
                                <!-- –í–∏–±—ñ—Ä –¥–Ω—ñ–≤ –º—ñ—Å—è—Ü—è -->
                                <div class="day-selector" id="monthdaySelector">
                                    <h6>–û–±–µ—Ä—ñ—Ç—å –¥–Ω—ñ –º—ñ—Å—è—Ü—è:</h6>
                                    <div class="d-flex flex-wrap justify-content-center">
                                        <!-- –ë—É–¥—É—Ç—å –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ JS -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –ß–∞—Å -->
                            <div class="form-section">
                                <h6><i class="fas fa-clock"></i> –í —è–∫–∏–π —á–∞—Å –Ω–∞–¥—Å–∏–ª–∞—Ç–∏?</h6>
                                <div class="time-input-group">
                                    <input type="time" class="form-control form-control-lg" id="notificationTime" required>
                                    <span class="text-muted">–ó–∞ –∫–∏—ó–≤—Å—å–∫–∏–º —á–∞—Å–æ–º</span>
                                </div>
                            </div>
                            
                            <!-- –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ -->
                            <div class="preview-section" id="previewSection" style="display: none;">
                                <h6><i class="fas fa-eye"></i> –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</h6>
                                <div id="previewText"></div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —ñ—Å–Ω—É—é—á–∏—Ö —Å–ø–æ–≤—ñ—â–µ–Ω—å -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-bell"></i> –Ü—Å–Ω—É—é—á—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h5>
                    <div>
                        <select class="form-select form-select-sm" id="filterType" style="width: auto; display: inline-block;">
                            <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                            <option value="daily_morning_notification">–†–∞–Ω–∫–æ–≤—ñ</option>
                            <option value="after_training_notification">–ü—ñ—Å–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</option>
                            <option value="custom_notification">–í–ª–∞—Å–Ω—ñ</option>
                        </select>
                        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="loadNotifications()">
                            <i class="fas fa-sync-alt"></i> –û–Ω–æ–≤–∏—Ç–∏
                        </button>
                    </div>
                </div>
                <div class="card-body" id="notificationsContainer">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                        </div>
                        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentUserId = '{{ user.telegram_id }}';
let selectedWeekdays = [];
let selectedMonthdays = [];
let selectedNotificationType = '';
let selectedFrequency = '';

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
document.addEventListener('DOMContentLoaded', function() {
    generateMonthdayButtons();
    loadNotifications();
    
    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∑–º—ñ–Ω–∏
    document.getElementById('filterType').addEventListener('change', loadNotifications);
    document.getElementById('simpleNotificationForm').addEventListener('submit', createSimpleNotification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É
    document.getElementById('notificationText').addEventListener('input', updatePreview);
    document.getElementById('notificationTime').addEventListener('change', updatePreview);
});

function generateMonthdayButtons() {
    const container = document.querySelector('#monthdaySelector .d-flex');
    container.innerHTML = '';
    
    for (let day = 1; day <= 31; day++) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'day-button';
        button.setAttribute('data-day', day);
        button.textContent = day;
        button.onclick = () => toggleMonthday(button);
        container.appendChild(button);
    }
}

function selectNotificationType(type) {
    selectedNotificationType = type;
    
    // –û—á–∏—â–∞—î–º–æ –≤—Å—ñ –≤–∏–±–æ—Ä–∏
    document.querySelectorAll('.frequency-option').forEach(el => el.classList.remove('selected'));
    
    // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å –¥–æ –æ–±—Ä–∞–Ω–æ—ó –æ–ø—Ü—ñ—ó
    const option = document.querySelector(`input[value="${type}"]`).closest('.frequency-option');
    option.classList.add('selected');
    
    // –ü–æ–∫–∞–∑—É—î–º–æ/–ø—Ä–∏—Ö–æ–≤—É—î–º–æ —Å–µ–∫—Ü—ñ—é —á–∞—Å—Ç–æ—Ç–∏
    const frequencySection = document.getElementById('frequencySection');
    if (type === 'custom_notification') {
        frequencySection.style.display = 'block';
    } else {
        frequencySection.style.display = 'none';
        selectedFrequency = '';
        hideAllDaySelectors();
    }
    
    updatePreview();
}

function selectFrequency(frequency) {
    selectedFrequency = frequency;
    
    // –û—á–∏—â–∞—î–º–æ –≤–∏–±–æ—Ä–∏ —á–∞—Å—Ç–æ—Ç–∏
    document.querySelectorAll('#frequencySection .frequency-option').forEach(el => el.classList.remove('selected'));
    
    // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å –¥–æ –æ–±—Ä–∞–Ω–æ—ó –æ–ø—Ü—ñ—ó
    const option = document.querySelector(`input[value="${frequency}"]`).closest('.frequency-option');
    option.classList.add('selected');
    
    // –ü–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–Ω—ñ–≤
    hideAllDaySelectors();
    
    if (frequency === 'weekly') {
        document.getElementById('weekdaySelector').style.display = 'block';
    } else if (frequency === 'monthly') {
        document.getElementById('monthdaySelector').style.display = 'block';
    }
    
    // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –≤–∏–±–æ—Ä–∏
    selectedWeekdays = [];
    selectedMonthdays = [];
    document.querySelectorAll('.weekday-button, .day-button').forEach(btn => btn.classList.remove('selected'));
    
    updatePreview();
}

function hideAllDaySelectors() {
    document.getElementById('weekdaySelector').style.display = 'none';
    document.getElementById('monthdaySelector').style.display = 'none';
}

function toggleWeekday(button) {
    const day = button.getAttribute('data-day');
    
    if (selectedWeekdays.includes(day)) {
        selectedWeekdays = selectedWeekdays.filter(d => d !== day);
        button.classList.remove('selected');
    } else {
        selectedWeekdays.push(day);
        button.classList.add('selected');
    }
    
    updatePreview();
}

function toggleMonthday(button) {
    const day = button.getAttribute('data-day');
    
    if (selectedMonthdays.includes(day)) {
        selectedMonthdays = selectedMonthdays.filter(d => d !== day);
        button.classList.remove('selected');
    } else {
        selectedMonthdays.push(day);
        button.classList.add('selected');
    }
    
    updatePreview();
}

function updatePreview() {
    const text = document.getElementById('notificationText').value;
    const time = document.getElementById('notificationTime').value;
    const previewSection = document.getElementById('previewSection');
    const previewText = document.getElementById('previewText');
    
    if (!text || !selectedNotificationType || !time) {
        previewSection.style.display = 'none';
        return;
    }
    
    let scheduleText = '';
    
    if (selectedNotificationType === 'daily_morning_notification') {
        scheduleText = `–©–æ–¥–Ω—è –æ ${time} (—Ä–∞–Ω–∫–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è)`;
    } else if (selectedNotificationType === 'after_training_notification') {
        scheduleText = `–ü—ñ—Å–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è (—Å–∏—Å—Ç–µ–º–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è)`;
    } else if (selectedNotificationType === 'custom_notification') {
        if (selectedFrequency === 'daily') {
            scheduleText = `–©–æ–¥–Ω—è –æ ${time}`;
        } else if (selectedFrequency === 'weekly' && selectedWeekdays.length > 0) {
            const dayNames = {
                '1': '–ü–Ω', '2': '–í—Ç', '3': '–°—Ä', '4': '–ß—Ç', 
                '5': '–ü—Ç', '6': '–°–±', '0': '–ù–¥'
            };
            const days = selectedWeekdays.map(d => dayNames[d]).join(', ');
            scheduleText = `–©–æ—Ç–∏–∂–Ω—è (${days}) –æ ${time}`;
        } else if (selectedFrequency === 'monthly' && selectedMonthdays.length > 0) {
            const days = selectedMonthdays.sort((a, b) => a - b).join(', ');
            scheduleText = `–©–æ–º—ñ—Å—è—Ü—è (${days} —á–∏—Å–ª–∞) –æ ${time}`;
        } else {
            scheduleText = '–û–±–µ—Ä—ñ—Ç—å –¥–Ω—ñ –¥–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è';
        }
    }
    
    previewText.innerHTML = `
        <strong>üì± –¢–µ–∫—Å—Ç —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è:</strong> "${text}"<br>
        <strong>‚è∞ –†–æ–∑–∫–ª–∞–¥:</strong> ${scheduleText}
    `;
    
    previewSection.style.display = 'block';
}

async function createSimpleNotification(event) {
    event.preventDefault();
    
    const text = document.getElementById('notificationText').value;
    const time = document.getElementById('notificationTime').value;
    
    if (!selectedNotificationType) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ç–∏–ø —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è');
        return;
    }
    
    // –ì–µ–Ω–µ—Ä—É—î–º–æ cron –≤–∏—Ä–∞–∑ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤–∏–±—Ä–∞–Ω–∏—Ö –æ–ø—Ü—ñ–π
    let cronExpression = '';
    
    if (selectedNotificationType === 'daily_morning_notification') {
        // –î–ª—è —Ä–∞–Ω–∫–æ–≤–∏—Ö —Å–ø–æ–≤—ñ—â–µ–Ω—å cron –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω
        cronExpression = null;
    } else if (selectedNotificationType === 'after_training_notification') {
        // –î–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω—å –ø—ñ—Å–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è cron –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω
        cronExpression = null;
    } else if (selectedNotificationType === 'custom_notification') {
        const [hour, minute] = time.split(':');
        
        if (selectedFrequency === 'daily') {
            cronExpression = `${minute} ${hour} * * *`;
        } else if (selectedFrequency === 'weekly') {
            if (selectedWeekdays.length === 0) {
                alert('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –¥–µ–Ω—å —Ç–∏–∂–Ω—è');
                return;
            }
            cronExpression = `${minute} ${hour} * * ${selectedWeekdays.join(',')}`;
        } else if (selectedFrequency === 'monthly') {
            if (selectedMonthdays.length === 0) {
                alert('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –¥–µ–Ω—å –º—ñ—Å—è—Ü—è');
                return;
            }
            cronExpression = `${minute} ${hour} ${selectedMonthdays.join(',')} * *`;
        } else {
            alert('–û–±–µ—Ä—ñ—Ç—å —á–∞—Å—Ç–æ—Ç—É –¥–ª—è –≤–ª–∞—Å–Ω–æ–≥–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è');
            return;
        }
    }
    
    const formData = {
        user_id: currentUserId,
        notification_text: text,
        notification_type: selectedNotificationType,
        notification_time: time,
        custom_notification_cron: cronExpression,
        custom_notification_execute_once: false
    };
    
    try {
        const response = await fetch('/api/notifications/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            alert('–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ! üéâ');
            
            // –û—á–∏—â–∞—î–º–æ —Ñ–æ—Ä–º—É
            document.getElementById('simpleNotificationForm').reset();
            selectedNotificationType = '';
            selectedFrequency = '';
            selectedWeekdays = [];
            selectedMonthdays = [];
            
            // –û—á–∏—â–∞—î–º–æ –≤–∏–±–æ—Ä–∏
            document.querySelectorAll('.frequency-option').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.weekday-button, .day-button').forEach(btn => btn.classList.remove('selected'));
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Å–µ–∫—Ü—ñ—ó
            document.getElementById('frequencySection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
            hideAllDaySelectors();
            
            loadNotifications();
        } else {
            const error = await response.json();
            alert('–ü–æ–º–∏–ª–∫–∞: ' + (error.detail || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
        }
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è');
    }
}

async function loadNotifications() {
    try {
        const filterType = document.getElementById('filterType').value;
        const url = `/api/notifications/user/${currentUserId}${filterType ? `?notification_type=${filterType}` : ''}`;
        
        const response = await fetch(url);
        const notifications = await response.json();
        
        displayNotifications(notifications);
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å:', error);
        document.getElementById('notificationsContainer').innerHTML = 
            '<div class="alert alert-danger">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å</div>';
    }
}

function displayNotifications(notifications) {
    const container = document.getElementById('notificationsContainer');
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-bell-slash fa-3x mb-3"></i>
                <p>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
            </div>
        `;
        return;
    }
    
    const typeLabels = {
        'daily_morning_notification': 'üåÖ –†–∞–Ω–∫–æ–≤–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è',
        'after_training_notification': 'üèãÔ∏è –ü—ñ—Å–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è',
        'custom_notification': '‚öôÔ∏è –í–ª–∞—Å–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è'
    };
    
    const notificationsHtml = notifications.map(notification => {
        const statusClass = notification.is_active ? 'active' : 'inactive';
        const statusIcon = notification.is_active ? 'fas fa-bell text-success' : 'fas fa-bell-slash text-muted';
        const typeLabel = typeLabels[notification.notification_type] || notification.notification_type;
        
        return `
            <div class="notification-card card mb-3 ${statusClass}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <i class="${statusIcon} me-2"></i>
                                <h6 class="mb-0">${notification.notification_text}</h6>
                                <span class="badge bg-info notification-type-badge ms-2">
                                    ${typeLabel}
                                </span>
                            </div>
                            
                            <div class="text-muted small">
                                <i class="fas fa-clock me-1"></i>
                                ${notification.cron_human_readable || `–ß–∞—Å: ${notification.notification_time}`}
                            </div>
                            
                            <div class="text-muted small mt-1">
                                <i class="fas fa-calendar-plus me-1"></i>
                                –°—Ç–≤–æ—Ä–µ–Ω–æ: ${new Date(notification.created_at).toLocaleString('uk-UA')}
                            </div>
                        </div>
                        
                        <div class="col-md-4 text-end">
                            <button class="btn btn-sm ${notification.is_active ? 'btn-warning' : 'btn-success'} me-2" 
                                    onclick="toggleNotification('${notification.id}')">
                                <i class="fas ${notification.is_active ? 'fa-pause' : 'fa-play'}"></i>
                                ${notification.is_active ? '–í–∏–º–∫–Ω—É—Ç–∏' : '–£–≤—ñ–º–∫–Ω—É—Ç–∏'}
                            </button>
                            
                            <button class="btn btn-sm btn-danger" onclick="deleteNotification('${notification.id}')">
                                <i class="fas fa-trash"></i> –í–∏–¥–∞–ª–∏—Ç–∏
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = notificationsHtml;
}

async function toggleNotification(notificationId) {
    try {
        const response = await fetch(`/api/notifications/${notificationId}/toggle`, {
            method: 'PUT'
        });
        
        if (response.ok) {
            loadNotifications();
        } else {
            alert('–ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è');
        }
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è');
    }
}

async function deleteNotification(notificationId) {
    if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/notifications/${notificationId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadNotifications();
        } else {
            alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è');
        }
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è');
    }
}
</script>
{% endblock %}
